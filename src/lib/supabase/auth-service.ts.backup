import { supabase, isSupabaseConfigured } from './client'
import { DatabaseService } from './database-service'
import { getSession } from 'next-auth/react'

export class AuthService {
  // Helper method to check if Supabase operations can be performed
  private static checkSupabaseConfig() {
    if (!isSupabaseConfigured()) {
      console.warn('Supabase client is not properly configured. Some features may not work.')
      return false
    }
    return true
  }

  // Full signup flow: Create in auth.users + subscribers
  static async signUp(userData: {
    email: string
    password: string
    fullName?: string
    metadata?: any
  }) {
    try {
      if (!this.checkSupabaseConfig()) {
        return { success: false, error: 'Service configuration error' }
      }

      // Step 1: Create user in auth.users (Supabase handles password hashing)
      const { data: authData, error: authError } = await supabase.auth.signUp({
        email: userData.email,
        password: userData.password,
        options: {
          data: {
            full_name: userData.fullName,
            ...userData.metadata
          }
        }
      })

      if (authError) throw authError
      if (!authData.user) throw new Error('No user data returned')

      // Step 2: Create user in subscribers table
      const subscriberResult = await DatabaseService.registerUser({
        user_id: authData.user.id,
        email: userData.email,
        full_name: userData.fullName,
        name: userData.fullName,
        metadata: userData.metadata
      })

      if (!subscriberResult.success) {
        console.error('Failed to create subscriber:', subscriberResult.error)
        // Note: User is created in auth but not in subscribers
        // You might want to handle this differently
      }

      return {
        success: true,
        user: authData.user,
        subscriber: subscriberResult.data,
        needsEmailConfirmation: !authData.user.email_confirmed_at
      }
    } catch (error) {
      console.error('Signup error:', error)
      return { success: false, error }
    }
  }

  // Full login flow: Authenticate + get subscriber data
  static async signIn(credentials: {
    email: string
    password: string
  }) {
    try {
      if (!this.checkSupabaseConfig()) {
        return { success: false, error: 'Service configuration error' }
      }

      // Step 1: Authenticate with auth.users
      const { data: authData, error: authError } = await supabase.auth.signInWithPassword({
        email: credentials.email,
        password: credentials.password
      })

      if (authError) throw authError
      if (!authData.user) throw new Error('No user data returned')

      // Step 2: Check if subscriber record exists
      const subscriberResult = await DatabaseService.getSubscriberProfile(authData.user.id)
      
      if (subscriberResult.success && subscriberResult.data) {
        // Subscriber exists - return existing data
        console.log('Found existing subscriber for user:', authData.user.id)
        return {
          success: true,
          user: authData.user,
          subscriber: subscriberResult.data,
          session: authData.session
        }
      }
      
      // Step 3: Subscriber doesn't exist - create one (for users from other apps)
      console.log('No subscriber found for auth user, creating new subscriber record')
      const newSubscriber = await DatabaseService.registerUser({
        user_id: authData.user.id,
        email: authData.user.email,
        full_name: authData.user.user_metadata?.full_name,
        name: authData.user.user_metadata?.full_name,
        metadata: { 
          migrated: true,
          migratedAt: new Date().toISOString(),
          sourceApp: 'waffle-payments'
        }
      })
      
      if (!newSubscriber.success) {
        // Failed to create subscriber - still return auth data
        console.error('Failed to create subscriber for migrated user:', newSubscriber.error)
        return {
          success: true,
          user: authData.user,
          subscriber: null,
          session: authData.session,
          warning: 'Could not create app profile'
        }
      }
      
      console.log('Successfully created subscriber for migrated user')
      return {
        success: true,
        user: authData.user,
        subscriber: newSubscriber.data,
        session: authData.session,
        isNewSubscriber: true
      }
    } catch (error) {
      console.error('Login error:', error)
      return { success: false, error }
    }
  }

  // Get current user (supports both email and wallet auth)
  static async getCurrentUser() {
    try {
      // Use the API endpoint to get user profile (works for both client and server)
      const response = await fetch('/api/user/profile', {
        method: 'GET',
        headers: {
          'Content-Type': 'application/json',
        },
        credentials: 'include', // Include cookies for session
      });

      if (!response.ok) {
        if (response.status === 401) {
          return { success: false, error: 'Not authenticated' };
        }
        throw new Error(`HTTP ${response.status}`);
      }

      const result = await response.json();
      return result;

    } catch (error) {
      console.error('Error getting current user:', error);
      return { success: false, error };
    }
  }

  // Check if user is authenticated (email or wallet)
  static async isAuthenticated() {
    try {
      const result = await this.getCurrentUser()
      return result.success && result.user
    } catch (error) {
      console.error('Error checking authentication:', error)
      return false
    }
  }

  // Sign out (handles both email and wallet auth)
  static async signOut() {
    try {
      // Sign out from NextAuth (wallet users)
      const { signOut: nextAuthSignOut } = await import('next-auth/react')
      await nextAuthSignOut({ redirect: false })
      
      // Sign out from Supabase (email users) - only if configured
      if (this.checkSupabaseConfig()) {
        const { error } = await supabase.auth.signOut()
        if (error) throw error
      }
      
      return { success: true }
    } catch (error) {
      console.error('Error signing out:', error)
      return { success: false, error }
    }
  }

  // Password reset
  static async resetPassword(email: string) {
    try {
      const { error } = await supabase.auth.resetPasswordForEmail(email, {
        redirectTo: `${window.location.origin}/reset-password`
      })
      
      if (error) throw error
      return { success: true }
    } catch (error) {
      console.error('Password reset error:', error)
      return { success: false, error }
    }
  }

  // Update password
  static async updatePassword(newPassword: string) {
    try {
      const { error } = await supabase.auth.updateUser({
        password: newPassword
      })
      
      if (error) throw error
      return { success: true }
    } catch (error) {
      console.error('Update password error:', error)
      return { success: false, error }
    }
  }
} 